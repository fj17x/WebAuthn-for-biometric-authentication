<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
</head>

<body>
	<p>Make sure you are on "localhost" and not "127.0.0.1"</p>
	<p>Make sure you are running node version >=19.2.0</p>
	<label for="uname">Username:</label>
	<input name="name" id="uname" type="text">
	<button onclick="reg()">Register</button><br>
	<button onclick="login()">Login</button>


	<script type="module">
		import * as webauthn from 'https://unpkg.com/@passwordless-id/webauthn'

		var nonce
		var username

		//ECMAScript modules (i.e type="module") is not globally scoped, so we explicitly add to window object.
		window.reg = async function () {

			//To get a nonce(random value) given by the server.
			await fetch("http://localhost:8000/getNonce")
				.then((res) => res.text())
				.then((data) => { nonce = data })

			//Get user input
			username = document.getElementById("uname").value
			console.log(username)
			console.log('nonce: ', nonce);

			//Use browser WebAuth Protocol
			//Arguments are: 1.Username(default:"Demo"), 2. Nonce(so server can identify), 3.Authenticator type(Phone/PC/Security Key etc.) 4.Timeout(6 seconds)
			const registration = await webauthn.client.register(username ? username : "Demo", nonce, {
				"authenticatorType": "both",
				"timeout": 60000,
			})

			console.log(registration);

			//Send the registration object returned by the webauthn protocol to the server.
			await fetch("http://localhost:8000/Register", {
				method: "POST",
				headers: {
					'Accept': 'application/json',
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(registration)
			})

		}


		window.login = async function () {
			try {
				username = document.getElementById("uname").value
				const response = await fetch("http://localhost:8000/getUsernameToId", {
					method: "POST",
					headers: {
						'Accept': 'application/json',
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ username })
				})

				if (!response.ok) {
					throw new Error(response.status);
				}

				let currentJSON = await response.json()
				console.log('currentJSON: ', currentJSON);
				let currentUserId = currentJSON.id
				let nonce = currentJSON.nonce

				console.log('currentUserId: ', currentUserId);

				//Get an authentication object with the same credential ID, so we can send it to server using fetch.
				const authentication = await webauthn.client.authenticate([currentUserId], nonce, {
					"authenticatorType": "both",
					"userVerification": "required",
					"timeout": 60000
				})
				console.log('authentication: ', authentication);

				const checkLoginStatus = await fetch("http://localhost:8000/Login", {
					method: "POST",
					headers: {
						'Accept': 'application/json',
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(authentication)
				})

				if (!checkLoginStatus.ok) {
					throw new Error(response.status);
				}

				alert("Login successful, username: " + username)
			}
			catch (e) {

				if (e.message == 404) {
					alert("No account found.")
				}
			}
		}


	</script>


</body>

</html>